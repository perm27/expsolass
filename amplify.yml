version: 1
frontend:
  phases:
    preBuild:
      commands:
        # 1. Node.jsã¨Amplify CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        - npm install -g @aws-amplify/cli@latest
        
        # 2. ä¾å­˜é–¢ä¿‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (åŒæœŸã‚¨ãƒ©ãƒ¼å¯¾ç­–ã¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ )
        - npm ci || npm install
        
        # 3. AWS_REGIONã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼å¯¾ç­–)
        # â€» ç’°å¢ƒå¤‰æ•°AMPLIFY_REGIONãŒAmplify Consoleã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æ
        - export AWS_REGION=${AMPLIFY_REGION}

    build:
      commands:
        # 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨amplify_outputs.jsonã®ç”Ÿæˆ
        # ampx: command not found å¯¾ç­–ã¨ã—ã¦ npx ã‚’è¿½åŠ 
        - npx ampx pipeline-deploy --branch ${AWS_BRANCH} --app-id ${AMPLIFY_APP_ID}

        # 5. ğŸŒŸ ä¿®æ­£: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã€AWSã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ˜ç¤ºçš„ã«å–å¾— ğŸŒŸ
        # --format json ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã®ã§çœç•¥å¯èƒ½ã§ã™ãŒã€æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¾ã™ã€‚
        # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ) ã« amplify_outputs.json ã‚’ç”Ÿæˆ
        - npx ampx generate outputs --output-path amplify_outputs.json
        
        # 6. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® src ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        # ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆã‚’æ˜ç¢ºã«æŒ‡å®š
        - cp ./amplify_outputs.json ./frontend/src/

        # 7. frontendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã€ä¾å­˜é–¢ä¿‚ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        - cd frontend
        - npm ci || npm install

        # 8. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
        - npm run build

  artifacts:
    baseDirectory: frontend/build # Reactãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¨™æº–çš„ãªãƒ“ãƒ«ãƒ‰å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      # frontend å†…ã® node_modules ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ã«è¿½åŠ 
      - frontend/node_modules/**/* ```

