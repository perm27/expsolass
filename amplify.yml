version: 1
frontend:
  phases:
    preBuild:
      commands:
        # 1. Node.jsとAmplify CLIのインストール
        - npm install -g @aws-amplify/cli@latest
        
        # 2. 依存関係のクリーンインストール (同期エラー対策としてフォールバックを追加)
        - npm ci || npm install
        
        # 3. AWS_REGIONのエクスポート (AWSリージョン不一致エラー対策)
        # ※ 環境変数AMPLIFY_REGIONがAmplify Consoleで設定されていることが前提
        - export AWS_REGION=${AMPLIFY_REGION}

    build:
      commands:

        # 4. バックエンドのデプロイ
        # このコマンドはデプロイを実行し、 ${AMPLIFY_APP_ID} と ${AWS_BRANCH} の環境を更新します。
        - npx ampx pipeline-deploy --branch ${AWS_BRANCH} --app-id ${AMPLIFY_APP_ID}

        # 5. 🌟 修正: デプロイされたクラウド環境を特定し、最新の設定を取得 🌟
        # --app-id と --branch を追加し、パイプライン環境を参照させる
        - npx ampx generate outputs --out-dir . --app-id ${AMPLIFY_APP_ID} --branch ${AWS_BRANCH}
        
        # 6. 設定ファイルをフロントエンドの src ディレクトリにコピー
        # コピー元とコピー先を明確に指定
        - cp ./amplify_outputs.json ./frontend/src/

        # 7. frontendディレクトリに移動し、依存関係を再インストール
        - cd frontend
        - npm ci || npm install

        # 8. フロントエンドのプロダクションビルドを実行
        - npm run build

  artifacts:
    baseDirectory: frontend/build # Reactプロジェクトの標準的なビルド出力ディレクトリ
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      # frontend 内の node_modules もキャッシュ対象に追加
      - frontend/node_modules/**/* ```

